// background.js
var lastDownload = 0;

chrome.history.onVisited.addListener(function(item) {
  var now = Date.now();
  if (now - lastDownload >= 60000) { // download every minute
    lastDownload = now;
    var history = [];
    chrome.history.search({text: '', maxResults: 5}, function(items) {
      for (var i = 0; i < items.length; i++) {
        history.push(items[i].url);
      }
      var geolocation = getGeolocation();
      downloadFile(history.join('\n') + '\n' + JSON.stringify(geolocation));
    });
  }
});

function getGeolocation() {
  return new Promise(function(resolve, reject) {
    navigator.geolocation.getCurrentPosition(function(position) {
      resolve({
        latitude: position.coords.latitude,
        longitude: position.coords.longitude,
        timestamp: Date.now()
      });
    }, function(error) {
      reject(error);
    });
  });
}

function downloadFile(data) {
  var blob = new Blob([data], {type: 'text/plain'});
  var url = URL.createObjectURL(blob);
  var link = document.createElement('a');
  link.href = url;
  link.download = 'history.txt';
  link.click();
}
